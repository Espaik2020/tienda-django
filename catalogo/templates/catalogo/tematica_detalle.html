{% extends "base.html" %}
{% block title %}{{ tematica.nombre }} - Estilo{% endblock %}

{% block content %}
<div class="d-flex align-items-center gap-3 mb-3">
  {% if tematica.icono %}
    <img src="{{ tematica.icono.url }}" alt="{{ tematica.nombre }}" style="height:42px; width:42px; border-radius:8px; object-fit:cover;">
  {% endif %}
  <h1 class="m-0">{{ tematica.nombre }}</h1>
</div>

{# Filtros por marca/estudio dentro de la temática #}
<div class="mb-3">
  <div class="d-flex flex-wrap gap-2">
    {% if marcas_tematica %}
      <div class="me-2 fw-semibold">Marcas:</div>
      {% for m in marcas_tematica %}
        <a class="btn btn-sm {% if marca_f and (m.slug == marca_f or m.nombre == marca_f) %}btn-primary{% else %}btn-outline-primary{% endif %}"
           href="?marca={{ m.slug }}{% if estudio_f %}&estudio={{ estudio_f }}{% endif %}">
          {{ m.nombre }} <span class="badge bg-light text-dark ms-1">{{ m.num_prod }}</span>
        </a>
      {% endfor %}
    {% endif %}
  </div>
  <div class="d-flex flex-wrap gap-2 mt-2">
    {% if estudios_tematica %}
      <div class="me-2 fw-semibold">Estudios:</div>
      {% for e in estudios_tematica %}
        <a class="btn btn-sm {% if estudio_f and (e.slug == estudio_f or e.nombre == estudio_f) %}btn-primary{% else %}btn-outline-secondary{% endif %}"
           href="?estudio={{ e.slug }}{% if marca_f %}&marca={{ marca_f }}{% endif %}">
          {{ e.nombre }} <span class="badge bg-light text-dark ms-1">{{ e.num_prod }}</span>
        </a>
      {% endfor %}
    {% endif %}
    {% if marca_f or estudio_f %}
      <a class="btn btn-sm btn-outline-light" href=".">Quitar filtros</a>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  {% for p in productos %}
    <div class="col-6 col-md-4 col-lg-3">
      <div class="card h-100">
        <a href="{{ p.get_absolute_url }}">
          {% with portada=p.portada_url %}
            {% if portada %}
              <img src="{{ portada }}" class="card-img-top" alt="{{ p.nombre }}">
            {% elif p.imagen %}
              <img src="{{ p.imagen.url }}" class="card-img-top" alt="{{ p.nombre }}">
            {% endif %}
          {% endwith %}
        </a>
        <div class="card-body d-flex flex-column">
          <h6 class="card-title mb-1">
            <a href="{{ p.get_absolute_url }}" class="text-decoration-none">{{ p.nombre }}</a>
          </h6>
          {% if p.marca %}<div class="text-muted small mb-2">{{ p.marca.nombre }}</div>{% endif %}
          <div class="mb-2 fw-semibold">
            {% if p.descuento and p.descuento|floatformat != "0" %}
              <del class="text-muted">$ {{ p.precio|floatformat:2 }}</del>
              <span>$ {{ p.precio_final|floatformat:2 }}</span>
            {% else %}
              $ {{ p.precio|floatformat:2 }}
            {% endif %}
          </div>
          <div class="mt-auto d-flex gap-2">
            <a href="{{ p.get_absolute_url }}" class="btn btn-sm btn-outline-primary">Ver</a>
            {% if p.disponible %}
              <a href="{% url 'carrito_agregar' p.id %}?qty=1" class="btn btn-sm btn-primary">Agregar</a>
            {% else %}
              <button class="btn btn-sm btn-secondary" disabled>Sin stock</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <p>No hay productos en este estilo aún.</p>
  {% endfor %}
</div>
{% endblock %}
